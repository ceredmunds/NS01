---
title: "NS01: Binary choice vs. strength-of-preference"
output: html_notebook
author: "C E R Edmunds"
date: 20-02-2019
---

```{r Setup, message=F}
rm(list=ls()) 

require(data.table); require(plyr); require(glmer)

data <- fread('/Users/arlo/Documents/DAUs/NS01/analysis/NS01fixationsLong.csv', stringsAsFactors=F)

effedUp <- c(1)
badCalib <- c(6, 9, 11, 14, 15, 24, 26, 34, 10, 22)

data <- data[!participantNo %in% badCalib,]
```

# Get summary statistics
```{r}
N <- length(unique(data$participantNo))
```

# Exclusions
We excluded all participants who were outliers in the time spent off task.
```{r}
binary <- data[task=='binary' & intra_choice==1,]
binary[, onTask:= ifelse(aoi=="left" | aoi=="right" | aoi=="likertHorizontal", 1, 0)]
binary[, onTaskTime:= onTask*fixDurationProp]
binary.summary <- aggregate(onTaskTime ~ participantNo + trial, data=binary, FUN=sum)

boxplot(onTaskTime ~ participantNo, data=binary.summary)

continuous <- data[task=='continuous' & intra_choice==1,]
continuous[, onTask:= ifelse(aoi=="left" | aoi=="right" | aoi=="likertHorizontal", 1, 0)]
continuous[, onTaskTime:= onTask*fixDurationProp]
continuous.summary <- aggregate(onTaskTime ~ participantNo + trial, data=continuous, FUN=sum)

boxplot(onTaskTime ~ participantNo, data=continuous.summary)

```


We excluded all trials with reaction times less than 200ms and trials where the reaction time is 3 standard deviations above the mean reaction time across all trials.
```{r}
# Excluding trials based on reaction times
data[, excludeTrial:= ifelse(rt<200 | rt>mean(rt)+3*sd(rt), 1, 0)]
data[, exclude:= excludeTrial/.N, by=list(participantNo, trial)]

# Summary of exclusions by reaction time
exclusions <- aggregate(data$exclude, list(data$participantNo), sum)
colnames(exclusions) <- c("participantNo", "nExclusions")
exclusions["percentExcluded"] <- (exclusions$nExclusions/300)*100
percentTrialsExcluded <- mean(exclusions$percentExcluded)

# Remove those trials
data <- data[exclude==0,]
```

# Manipulation checks
Looking at responses in the continuous task
```{r}
hist(continuous$response, breaks=1:100)

continuous[, rescaledResponse:= ifelse(response<=50, response, 101-response)]
continuous.responses <- aggregate(rescaledResponse ~ participantNo + block, data=continuous, FUN=sd)

boxplot(rescaledResponse ~ participantNo, data=continuous)
boxplot(rescaledResponse ~ participantNo, data=continuous[block==1])
boxplot(rescaledResponse ~ participantNo, data=continuous[block==2])

# Looking to see whether this makes a difference for different blocks
t.test(rescaledResponse ~ block, data=continuous)

# Looking at entropy of decisions
entropy.table <- dcast(continuous, participantNo + rescaledResponse ~ ., 
                       value.var = "rescaledResponse")
colnames(entropy.table) <- c("participantNo", "rescaledResponse", "N")

x <- ddply(entropy.table, .(participantNo), summarize, 
      entropy = entropy(N, method="Laplace"))
barplot(x$entropy)
```
# Analysis
```{r}
fixations <- dcast(data[task!="valuation",], participantNo + task + block + trial + response + rt + 
                     lValue + rValue ~ aoi, 
                   fun = sum, value.var="fixDurationProp")
fixations[, V1:=NULL]

fixations[, value.difference:=lValue-rValue]
fixations[, attention.difference:=left-right]

fixations[, response:=as.double(response)]
fixations[task=="binary", response:= response-1]
fixations[task=="continuous", response:= (response-1.0)/99.0]

fixations[, recodedResponse:= response]
fixations[task=="continuous", recodedResponse:= ifelse(recodedResponse<=0.5, 0, 1)]

model <- glmer(recodedResponse ~ value.difference * attention.difference * task  + 
               (1 | value.difference ), data=fixations, 
             family=binomial)
summary(model)
```



# Order effects
For within-subjects analysis:
glmer(choice ~ value.difference * attention.difference * condition + (1 | value.difference * attention.difference * condition || subject), family=binomial)

```{r}





```



# Analysis

```{r}

```