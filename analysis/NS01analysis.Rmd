---
title: 'NS01: Binary choice vs. strength-of-preference'
author: "C E R Edmunds"
date: "20-02-2019"
output:
  html_document:
    df_print: paged
---

```{r Setup, message=F, echo=F, results='hide'}
rm(list=ls()) 

require(data.table); require(plyr); require(lme4); require(ggplot2)

data <- fread('/Users/arlo/Documents/DAUs/NS01/analysis/NS01fixationsLong.csv', stringsAsFactors=F)

effedUp <- c(1)
badCalib <- c(6, 9, 11, 14, 15, 24, 26, 34, 10, 22, 42, 47) # Wrong eye

data <- data[!participantNo %in% badCalib,]
```

## Summary statistics
```{r Summary statistics, echo=FALSE}
N <- length(unique(data$participantNo))
```

### Participants
In total, we have `r N` participants after excluding those for whom the fixation cross did not work (due to experimenter error) and 2 people for which the eye-tracker would not initially calibrate. 

## Exclusions
```{r Exclusions based on attention: binary task}
binary <- data[task=='binary' & intra_choice==1,]
binary[, onTask:= ifelse(aoi=="left" | aoi=="right" | aoi=="likertHorizontal", 1, 0)]
binary[, onTaskProp:= onTask*fixLengthTr/rt]
binary.summary <- as.data.table(aggregate(onTaskProp ~ participantNo + trial, data=binary, FUN=sum))

binary.summary.plot <- as.data.table(aggregate(onTaskProp ~ participantNo, data=binary.summary, FUN=mean))

boxplot(binary.summary.plot$onTaskProp)
# One outlier at around 0.53, propose cut off of 60% 

binary.histogram <- ggplot(binary.summary.plot, aes(x=onTaskProp)) + 
  geom_histogram(binwidth=0.01) +
  theme_minimal() +
  
  labs(title="Histogram of proportion of time on task for every participant in binary task", 
       x="Proportion of trial on task", y="Count") +
  xlim(c(0.5, 1))
binary.histogram

# Get excluded participant
binaryExclusions <- c(binary.summary.plot[onTaskProp<0.60, participantNo])

# Remove participant
data <- data[!participantNo %in% binaryExclusions,]

# Tidying
rm(binary.summary, binary.summary.plot)
```

```{r Exclusions based on attention: continuous task}
continuous <- data[task=='continuous' & intra_choice==1,]
continuous[, onTask:= ifelse(aoi=="left" | aoi=="right" | aoi=="likertHorizontal", 1, 0)]
continuous[, onTaskProp:= onTask*fixLengthTr/rt]
continuous.summary <- as.data.table(aggregate(onTaskProp ~ participantNo + trial, 
                                              data=continuous, FUN=sum))

continuous.summary.plot <- as.data.table(aggregate(onTaskProp ~ participantNo, 
                                                   data=continuous.summary, FUN=mean))

boxplot(continuous.summary.plot$onTaskProp)
# No outliers according to boxplot 

continuous.histogram <- ggplot(continuous.summary.plot, aes(x=onTaskProp)) + 
  geom_histogram(binwidth=0.01) + 
  theme_minimal() +
  labs(title="Histogram of time on task for every participant in continuous task", 
       x="Time on task", y="Count") +
  xlim(c(0.5, 1))
continuous.histogram

# Not really needed, due to lack of exclusions. There in case change mind.
# Get excluded participant(s)
continuousExclusions <- c(continuous.summary.plot[onTaskProp<0, participantNo])

# Remove participant
data <- data[!participantNo %in% continuousExclusions,]

# Tidying
rm(continuous.summary, continuous.summary.plot)
```
As preregistered, we excluded participants on the basis of time on task. Time on task was operationalized as the proportion of time during the trial where participants were fixating on either the pictures or the response scale. We then plotted a histogram of the mean proportion for each participant to determine where a natural break point would be. For the binary task, this turned out to be 0.60. This resulted in excluding `r length(binaryExclusions) + length(contExclusions)` participants, resulting in `r length(unique(data$participantNo))` remaining participants. 

Additionally, we excluded all trials with reaction times less than 200ms and trials where the reaction time is 3 standard deviations above the mean reaction time across all trials.
```{r Exclusions based on reaction times}
# Excluding trials based on reaction times
data[, excludeTrial:= ifelse(rt<200 | rt>mean(rt)+3*sd(rt), 1, 0)]
data[, exclude:= excludeTrial/.N, by=list(participantNo, trial)]

# Summary of exclusions by reaction time
exclusions <- aggregate(data$exclude, list(data$participantNo), sum)
colnames(exclusions) <- c("participantNo", "nExclusions")
exclusions["percentExcluded"] <- (exclusions$nExclusions/300)*100
percentTrialsExcluded <- mean(exclusions$percentExcluded)

# Remove those trials
data <- data[excludeTrial==0,]
```

<!-- # Manipulation checks -->
<!-- Looking at responses in the continuous task -->
<!-- ```{r} -->
<!-- hist(continuous$response, breaks=1:100) -->

<!-- continuous[, rescaledResponse:= ifelse(response<=50, response, 101-response)] -->
<!-- continuous.responses <- aggregate(rescaledResponse ~ participantNo + block, data=continuous, FUN=sd) -->

<!-- boxplot(rescaledResponse ~ participantNo, data=continuous) -->
<!-- boxplot(rescaledResponse ~ participantNo, data=continuous[block==1]) -->
<!-- boxplot(rescaledResponse ~ participantNo, data=continuous[block==2]) -->

<!-- # Looking to see whether this makes a difference for different blocks -->
<!-- t.test(rescaledResponse ~ block, data=continuous) -->

<!-- # # Looking at entropy of decisions -->
<!-- # entropy.table <- dcast(continuous, participantNo + rescaledResponse ~ .,  -->
<!-- #                        value.var = "rescaledResponse") -->
<!-- # colnames(entropy.table) <- c("participantNo", "rescaledResponse", "N") -->
<!-- #  -->
<!-- # x <- ddply(entropy.table, .(participantNo), summarize,  -->
<!-- #       entropy = entropy(N, method="Laplace")) -->
<!-- # barplot(x$entropy) -->
<!-- ``` -->

## Analysis
```{r Analysis}
fixations <- dcast(data, participantNo + task + taskOrder + block + trial + response + rt +
                     lValue + rValue ~ aoi,
                   fun = sum, value.var="fixDurationProp")
fixations[, V1:=NULL]

fixations[, value.difference:=rValue-lValue]
fixations[, attention.difference:=right-left]

fixations[, response:=as.double(response)]
fixations[task=="binary", response:= response-1]
fixations[task=="continuous", response:= (response-1.0)/99.0]

fixations[, recodedResponse:= response]
fixations[task=="continuous", recodedResponse:= ifelse(recodedResponse<=0.5, 0, 1)]

order.model <- glmer(recodedResponse ~ taskOrder + (1|participantNo), 
                     data = fixations[!task=="valuation"], 
                     family = binomial)
summary(order.model)

attention.model <- glmer(recodedResponse ~ attention.difference + 
                           (1 + attention.difference|participantNo), 
               data = fixations[!task=="valuation"],
               family = binomial)
summary(attention.model)

attention.task.model <- glmer(recodedResponse ~ attention.difference*task + 
                                (1 + attention.difference|participantNo), 
               data = fixations[!task=="valuation"],
               family = binomial)
summary(attention.task.model)

value.model <- glmer(recodedResponse ~ value.difference + 
                           (1 + value.difference|participantNo), 
               data = fixations[!task=="valuation"],
               family = binomial)
summary(value.model)

value.task.model <- glmer(recodedResponse ~ value.difference*task + 
                                (1 + value.difference|participantNo), 
               data = fixations[!task=="valuation"],
               family = binomial)
summary(value.task.model)

attention.value.interaction <- glmer(recodedResponse ~ attention.difference*value.difference + 
                           (1 + value.difference|participantNo), 
               data = fixations[!task=="valuation"],
               family = binomial)
summary(attention.value.interaction)

attention.value.task.interaction <- glmer(recodedResponse ~ attention.difference*value.difference*task + 
                           (1 + value.difference|participantNo) + (attention.difference-1|participantNo), 
               data = fixations[!task=="valuation"],
               family = binomial)
summary(attention.value.task.interaction)

anova(attention.value.task.interaction, attention.value.interaction)

```

```{r Analysis of continuous responses}
attention.model <- glmer(response ~ attention.difference + 
                           (1 + attention.difference|participantNo), 
               data = fixations[task=="continuous"],
               family = binomial)
summary(attention.model)

value.model <- glmer(response ~ value.difference + 
                           (1 + value.difference|participantNo), 
               data = fixations[task=="continuous"],
               family = binomial)
summary(value.model)


attention.value.interaction <- glmer(response ~ attention.difference*value.difference + 
                           (1 + value.difference||participantNo), 
               data = fixations[task=="continuous"],
               family = binomial)
summary(attention.value.interaction)
```

# To do
- models by task (data[task=="cont"] etc.)
- full interaction model to show between task effect
- inverse-U relationship between value and rt? in rating tasks.